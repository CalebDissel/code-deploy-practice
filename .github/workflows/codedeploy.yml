name: Deploy to AWS CodeDeploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Package and deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make hooks executable
        run: chmod +x scripts/*

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Sanity / who am I
        run: |
          set -x
          aws --version
          aws sts get-caller-identity
          echo "REGION=${{ vars.AWS_REGION }}"
          echo "APP=${{ vars.CODEDEPLOY_APPLICATION }}"
          echo "DG=${{ vars.CODEDEPLOY_DEPLOYMENT_GROUP }}"
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}"
          # List bucket to confirm access/region
          aws s3 ls "s3://${{ secrets.S3_BUCKET }}/" || true

      - name: Validate CodeDeploy names early
        run: |
          set -euo pipefail
          aws deploy get-application \
            --application-name "${{ vars.CODEDEPLOY_APPLICATION }}"
          aws deploy get-deployment-group \
            --application-name "${{ vars.CODEDEPLOY_APPLICATION }}" \
            --deployment-group-name "${{ vars.CODEDEPLOY_DEPLOYMENT_GROUP }}"

      - name: Create deploy metadata
        run: |
          cat > deploy-info.json <<JSON
          {
            "repository": "${GITHUB_REPOSITORY}",
            "commit": "${GITHUB_SHA}"
          }
          JSON
          cat deploy-info.json

      - name: Package artifact
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          ARTIFACT_NAME="app-${TIMESTAMP}.zip"
          zip -r "$ARTIFACT_NAME" . -x ".git/*" "./.github/*"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV
          ls -lh "$ARTIFACT_NAME"

      - name: Upload artifact to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_PREFIX: ${{ vars.S3_PREFIX }}
        run: |
          set -euo pipefail
          if [ -z "$S3_BUCKET" ]; then
            echo "S3_BUCKET secret not set" >&2
            exit 1
          fi
          if [ -n "${S3_PREFIX:-}" ]; then
            S3_PREFIX="${S3_PREFIX#/}"; S3_PREFIX="${S3_PREFIX%/}"
            S3_KEY="${S3_PREFIX}/${ARTIFACT_NAME}"
          else
            S3_KEY="${ARTIFACT_NAME}"
          fi
          echo "Uploading to s3://$S3_BUCKET/$S3_KEY"
          aws s3 cp "$ARTIFACT_NAME" "s3://$S3_BUCKET/$S3_KEY" --no-progress
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV
          aws s3 ls "s3://$S3_BUCKET/$S3_KEY"

      - name: Create CodeDeploy deployment
        env:
          APPLICATION_NAME: ${{ vars.CODEDEPLOY_APPLICATION }}
          DEPLOYMENT_GROUP: ${{ vars.CODEDEPLOY_DEPLOYMENT_GROUP }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          set -euo pipefail
          cat > revision.json <<JSON
          {
            "revisionType": "S3",
            "s3Location": {
              "bucket": "${S3_BUCKET}",
              "key": "${S3_KEY}",
              "bundleType": "zip"
            }
          }
          JSON
          echo "Creating deployment for app=${APPLICATION_NAME}, dg=${DEPLOYMENT_GROUP}, key=${S3_KEY}"
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "$APPLICATION_NAME" \
            --deployment-group-name "$DEPLOYMENT_GROUP" \
            --revision file://revision.json \
            --query deploymentId --output text)
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" | tee -a $GITHUB_ENV

      - name: Wait for deployment
        run: |
          set -euo pipefail
          aws deploy get-deployment --deployment-id "$DEPLOYMENT_ID" --output table
          aws deploy wait deployment-successful --deployment-id "$DEPLOYMENT_ID"
          aws deploy get-deployment --deployment-id "$DEPLOYMENT_ID" --output table
